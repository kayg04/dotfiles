#!/usr/bin/env bash
# import sanity
set -euo pipefail

# global declarations
USER_DATA_DIR="${HOME}/.config/chromium/Apps"
EXT_DIR="${USER_DATA_DIR}/Default/Extensions"
EXTID_LIST=$(ls -1 "${EXT_DIR}" | grep -v Temp)
CHROMIUM_VERSION=$($(command -v chromium) --version | grep -o '\s[0-9][0-9]\.[0-9]' | tr -d ' ')

printDetails() {
    echo -e "Your Chromium version is ${CHROMIUM_VERSION}.\nYour profile is located at ${USER_DATA_DIR}."
}

checkForUpdate() {
    if [[ "${1}" -gt "${2}" ]]; then
        return 0
    else
        return 1
    fi
}

installExtension() {
    $(command -v chromium) --user-data-dir="${USER_DATA_DIR}" "${1}"
}

main() {
    printDetails

    for extID in ${EXTID_LIST}; do
        UPDATE_URL="https://clients2.google.com/service/update2/crx?response=redirect&acceptformat=crx2,crx3&prodversion=${CHROMIUM_VERSION}&x=id%3D${extID}%26installsource%3Dondemand%26uc"

        if [[ -n $(ls -1 "${EXT_DIR}/${extID}") ]]; then
            oldVersion=$(ls -1 "${EXT_DIR}/${extID}" | tail -1 | sed 's/\.//g; s/\_//g')
            newVersion=$(curl -s "${UPDATE_URL}" | grep --only extension_[0-9]*_[0-9]*_[0-9]*.*.crx | sed -e 's/extension_//g; s/\.crx//g; s/\.//g; s/\_//g')

            if checkForUpdate "${newVersion}" "${oldVersion}"; then
                installExtension "${UPDATE_URL}"
            fi
        else
            installExtension "${UPDATE_URL}"
        fi
    done
}

main "${@}"
