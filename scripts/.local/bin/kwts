#!/usr/bin/env bash
# import sanity
set -euo pipefail

# global declarations
SCRIPT_PATH=$(dirname $(realpath "$0"))
URL="https://github.com/kwin-scripts/kwin-tiling.git"

fetchSource() {
    echo -e "Fetching source..."
    if git clone --quiet "${URL}" "${SCRIPT_PATH}"/kwin-tiling; then
        echo -e "\t-> Source fetched successfully."
    else
        echo -e "\t-> Source couldn't be fetched."
    fi
}

installScript() {
    echo -e "Installing KWin Tiling Script..."
    if plasmapkg2 --type kwinscript --install "${SCRIPT_PATH}"/kwin-tiling 1>/dev/null 2>&1; then
        echo -e "\t-> Installation successful."
    else
        echo -e "\t-> Installation failed!"
    fi
}

updateScript() {
    echo -e "Updating KWin Tiling Script..."
    if plasmapkg2 --type kwinscript --upgrade "${SCRIPT_PATH}"/kwin-tiling 1> /dev/null 2>&1; then
        echo -e "\t-> Update successful."
    else
        echo -e "\t-> Update failed!"
    fi
}

fixConf() {
    # necessary for configuration option in KWin Scripts menu
    mkdir -p "${HOME}"/.local/share/kservices5
    ln -sf "${HOME}"/.local/share/kwin/scripts/kwin-script-tiling/metadata.desktop "${HOME}"/.local/share/kservices5/kwin-script-tiling.desktop
}

cleanUp() {
    echo -e "Cleaning up all the cruft..."
    rm -rf "${SCRIPT_PATH}"/kwin-tiling
}

main() {
    if [[ -d "${SCRIPT_PATH}"/kwin-tiling ]]; then
        cleanUp
    fi

    fetchSource
    if [[ -d /home/kayg/.local/share/kwin/scripts/kwin-script-tiling ]]; then
        updateScript
    else
        installScript
    fi

    fixConf
    cleanUp
}

main
