#!/usr/bin/env bash
# import sanity
set -euo pipefail

# global declarations
SCRIPT_PATH=$(dirname $(realpath "$0"))
URL="https://github.com/wsdfhjxc/virtual-desktop-bar.git"

fetchSource() {
    echo -e "Fetching source..."
    if git clone --quiet "${URL}" "${SCRIPT_PATH}"/virtual-desktop-bar; then
        echo -e "\t-> Source fetched successfully."
    else
        echo -e "\t-> Source couldn't be fetched."
    fi
}

installDeps() {
    echo -e "Installing dependencies (if any)..."

    if sudo pacman --sync --noconfirm --needed cmake extra-cmake-modules gcc 1> /dev/null 2>&1; then
        echo -e "\t-> Installed all required dependencies."
    else
        echo -e "\t-> All dependencies could not be installed!"
    fi
}

buildTarget() {
    cd "${SCRIPT_PATH}"/virtual-desktop-bar
    mkdir -p "${SCRIPT_PATH}"/virtual-desktop-bar/build
    cd "${SCRIPT_PATH}"/virtual-desktop-bar/build

    echo -e "Generating configuration..."
    if cmake "${SCRIPT_PATH}"/virtual-desktop-bar 1> /dev/null 2>&1; then
        echo -e "\t-> Configuration generated."
    else
        echo -e "\t-> Configuration generation failed!"
    fi

    echo -e "Building Virtual Desktop Bar..."
    if make -j$(nproc) 1> /dev/null; then
        echo -e "\t-> Building successful."
    else
        echo -e "\t-> Building failed!"
    fi
}

installTarget() {
    cd "${SCRIPT_PATH}"/virtual-desktop-bar/build

    echo -e "Installing target (need root permissions)..."
    if sudo make install 1> /dev/null 2>&1; then
        echo -e "\t-> Installing successful."
    else
        echo -e "\t-> Installing failed!"
    fi
}

cleanUp() {
    echo -e "Cleaning up all the cruft..."
    rm -rf "${SCRIPT_PATH}"/virtual-desktop-bar
}

main() {
    if [[ -d "${SCRIPT_PATH}"/virtual-desktop-bar ]]; then
        cleanUp
    fi

    fetchSource
    installDeps
    buildTarget
    installTarget
    cleanUp
}

main
