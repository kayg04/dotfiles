#!/usr/bin/env bash
export SCRIPT_PATH=$(dirname $(realpath "$0"))

buildLibrary() {
    cd "${SCRIPT_PATH}/spotifywm"

    echo -ne "Building library..."
    run make -j$(nproc)
}

moveLibrary() {
   echo -ne "Moving built library to /usr/lib (need root permissions)...\nEnter password, please: "
   run sudo --prompt="" mv "${SCRIPT_PATH}/spotifywm/spotifywm.so" /usr/lib
}

fixSpotify() {
    echo -ne "Moving desktop file to local directory to make above changes..."
    run cp /usr/share/applications/spotify.desktop "${HOME}"/.local/share/applications

    echo -ne "Making changes in the desktop file..."
    run "sed -Ei 's/^Exec=(.*)/Exec=LD_PRELOAD=\/usr\/lib\/spotifywm.so \1/g' "${HOME}"/.local/share/applications/spotify.desktop"
}

main() {
    source "${SCRIPT_PATH}/helper"

    fetchSource "https://github.com/dasJ/spotifywm"
    buildLibrary
    moveLibrary
    fixSpotify
    cleanUp
}

main
